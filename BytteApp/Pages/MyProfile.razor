@page "/myprofile"
@using Core
@inject BytteApp.Service.AnnonceService annonceService
@inject BytteApp.Service.LoginState loginState

<PageTitle>My Profile</PageTitle>

<h2>Min profil</h2>

@if (!loginState.IsLoggedIn())
{
    <div class="alert alert-warning">
        Du skal være logget ind for at se din profil og dine annoncer.
    </div>
}
else if (isLoading)
{
    <p>Indlæser...</p>
}
else if (!string.IsNullOrEmpty(loadError))
{
    <div class="alert alert-danger">
        Fejl: @loadError
    </div>
}
else
{
    <div class="row g-4">
        <!-- Boks 1: Brugerinformation -->
        <div class="col-12 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Brugerinformation</h5>
                </div>

                @if (userInfo == null)
                {
                    <div class="card-body">
                        <p>Ingen brugerdata fundet.</p>
                    </div>
                }
                else
                {
                    <div class="card-body d-flex align-items-start gap-3">
                        <div class="flex-shrink-0">
                            <img src="@userInfo.ProfileImageUrl"
                                 alt="Profilbillede"
                                 class="profile-image rounded-circle" />
                        </div>

                        <div class="flex-grow-1">
                            <dl class="row mb-0">
                                <dt class="col-sm-4">Navn</dt>
                                <dd class="col-sm-8">@userInfo.Name</dd>

                                <dt class="col-sm-4">Email</dt>
                                <dd class="col-sm-8">@userInfo.Email</dd>

                                <dt class="col-sm-4">Brugernavn</dt>
                                <dd class="col-sm-8">@userInfo.UserName</dd>

                                

                                <dt class="col-sm-4">Medlem siden</dt>
                                <dd class="col-sm-8">@userInfo.MemberSince.ToShortDateString()</dd>
                            </dl>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Boks 2: Aktive annoncer -->
        <div class="col-12 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Mine aktive annoncer</h5>
                </div>
                <div class="card-body">
                    @if (activeListings == null || !activeListings.Any())
                    {
                        <p>Du har ingen aktive annoncer.</p>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead>
                                <tr>
                                    <th>Titel</th>
                                    <th>Pris</th>
                                    <th>Status</th>
                                </tr>
                                </thead>
                                <tbody>
                                @foreach (var listing in activeListings)
                                {
                                    <tr>
                                        <td>@listing.Title</td>
                                        <td>@listing.Price.ToString("C")</td>
                                        <td><span class="badge bg-success">Aktiv</span></td>
                                    </tr>
                                }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Boks 3: Solgte / inaktive annoncer -->
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Mine solgte og inaktive annoncer</h5>
                </div>
                <div class="card-body">
                    @if (inactiveOrSoldListings == null || !inactiveOrSoldListings.Any())
                    {
                        <p>Du har ingen solgte eller inaktive annoncer.</p>
                    }
                    else
                    {
                        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                            @foreach (var listing in inactiveOrSoldListings)
                            {
                                var isSold = listing.Status.Equals("sold", StringComparison.OrdinalIgnoreCase);
                                <div class="col">
                                    <div class="card h-100 bg-light text-muted">
                                        <div class="card-body">
                                            <h6 class="card-title">@listing.Title</h6>
                                            <p class="card-text mb-1">Pris: @listing.Price.ToString("C")</p>
                                            <span class="badge @(isSold ? "bg-dark" : "bg-secondary")">
                                                @(isSold ? "Solgt" : "Inaktiv")
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Boks 4: Indkøbshistorik (placeholder - ingen datakilde endnu) -->
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Min indkøbshistorik</h5>
                </div>
                <div class="card-body">
                    <p>Ingen købsdata tilgængelig.</p>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    private string? loadError;

    private MyProfileUserInfo? userInfo;
    private List<MyProfileListing> activeListings = new();
    private List<MyProfileListing> inactiveOrSoldListings = new();

    protected override async Task OnInitializedAsync()
    {
        if (!loginState.IsLoggedIn())
        {
            isLoading = false;
            return;
        }

        try
        {
            var userid = loginState.LoggedInUser!;
            // Hent annoncer for bruger:
            var annoncer = await annonceService.GetByUser(userid) ?? new List<Annonce>();

            // Kort brugerinfo (dummy – udbyg når I har rigtig brugerprofil):
            userInfo = new MyProfileUserInfo
            {
                ProfileImageUrl = "images/default-profile.png",
                Name = userid,
                Email = $"{userid}@example.com",
                UserName = userid,
                
                MemberSince = DateTime.UtcNow.AddMonths(-1)
            };

            // Map til interne listeobjekter
            activeListings = annoncer
                .Where(a => a.Status.Equals("Active", StringComparison.OrdinalIgnoreCase))
                .Select(a => new MyProfileListing
                {
                    Title = a.title,
                    Price = a.price,
                    Status = "active"
                })
                .OrderByDescending(a => a.Price)
                .ToList();

            inactiveOrSoldListings = annoncer
                .Where(a => !a.Status.Equals("Active", StringComparison.OrdinalIgnoreCase))
                .Select(a => new MyProfileListing
                {
                    Title = a.title,
                    Price = a.price,
                    Status = a.Status.ToLowerInvariant() // fx "inactive", "sold"
                })
                .ToList();
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private class MyProfileUserInfo
    {
        public string? ProfileImageUrl { get; set; }
        public string Name { get; set; } = "";
        public string Email { get; set; } = "";
        public string UserName { get; set; } = "";
        
        public DateTime MemberSince { get; set; }
    }

    private class MyProfileListing
    {
        public string Title { get; set; } = "";
        public decimal Price { get; set; }
        public string Status { get; set; } = "";
    }
}