@page "/Market"

@using BytteApp.Components
@using BytteApp.Service
@using Core
@using Microsoft.AspNetCore.Components.Forms

@inject AnnonceService AnnonceService                 
@inject IAnnonceBilledeService AnnonceBilledeServicebilledeService         

<h3>Tilføj annonce</h3>

@* Viser status hvis annoncer endnu ikke er hentet *@
@if (annoncer is null)
{
    <p>Loading annoncer...</p>
}
else if (annoncer.Count == 0)
{
    <p>Ingen annoncer lige nu</p>
}
else
{
    <h2 class="mt-4">Annoncer</h2>

    @* Liste af alle annoncer i en tabel *@
    <table class="table table-striped">
        <thead>
        <tr>
            <th>Annonce Id</th>
            <th>Titel</th>
            <th>Billede</th>   @* NYT – billedevisning *@
            <th>Pris</th>
            <th>Lokalitet Id</th>
            <th>Status</th>
            <th>Beskrivelse</th>
            <th>Handling</th>
        </tr>
        </thead>

        <tbody>
        @foreach (var a in annoncer)
        {
            <tr>
                <td>@a.annonceid</td>
                <td>@a.title</td>

                @* Hvis annoncen har et billede, vis det *@
                <td>
                    @if (!string.IsNullOrEmpty(a.imageKey))
                    {
                        <img src="@AnnonceBilledeServicebilledeService.ConvertToUrl(a.imageKey)" 
                             alt="Annoncebillede" width="80" />
                    }
                </td>

                <td>@a.price</td>
                <td>@a.lid</td>
                <td>@a.Status</td>
                <td>@a.description</td>

                @* Slet-knap *@
                <td>
                    <button class="btn btn-sm btn-danger" @onclick="() => Delete(a.annonceid)">
                        Slet
                    </button>
                </td>
            </tr>
        }
        </tbody>
    </table>
}

@* Knappen der åbner modal-vinduet for at oprette ny annonce *@
<button class="btn btn-info" @onclick="OpenModal">Tilføj annonce</button>

@* Modal dialog for oprettelse af ny annonce *@
<ModalDialog @ref="addModalDialog" Title="Tilføj annonce...">

    @* Formular til oprettelse af annonce *@
    <EditForm Model="@newAnnonce" OnValidSubmit="@HandleSubmit" class="row p-3">
        <DataAnnotationsValidator />
        <ValidationSummary />

        @* --- FELTER TIL ANNONCE --- *@
        <div class="col-md-6 mb-3">
            <label for="AnnonceId">Annonce Id</label>
            <InputNumber id="AnnonceId" @bind-Value="newAnnonce.annonceid" class="form-control" />
        </div>

        <div class="col-md-6 mb-3">
            <label for="Title">Titel</label>
            <InputText id="Title" @bind-Value="newAnnonce.title" class="form-control" />
        </div>

        <div class="col-md-6 mb-3">
            <label for="Price">Pris</label>
            <InputNumber id="Price" @bind-Value="newAnnonce.price" class="form-control" />
        </div>

        <div class="col-md-6 mb-3">
            <label for="Lid">Lokalitet Id</label>
            <InputNumber id="Lid" @bind-Value="newAnnonce.lid" class="form-control" />
        </div>

        <div class="col-md-6 mb-3">
            <label for="Status">Status</label>
            <InputText id="Status" @bind-Value="newAnnonce.Status" class="form-control" />
        </div>

        <div class="col-md-12 mb-3">
            <label for="Description">Beskrivelse</label>
            <InputTextArea id="Description" @bind-Value="newAnnonce.description" class="form-control" />
        </div>

        @* --- BILLEDEUPLOAD --- *@
        <div class="col-md-12 mb-3">
            <label for="Image">Billede</label><br />

            @* Brugeren vælger et billede fra sin computer *@
            <InputFile OnChange="OnImageSelected" />

            @* Tekst feedback til upload *@
            @if (!string.IsNullOrEmpty(uploadStatus))
            {
                <div class="mt-1">
                    <small class="text-muted">@uploadStatus</small>
                </div>
            }

            @* Billede-preview efter upload *@
            @if (!string.IsNullOrEmpty(newAnnonce.imageKey))
            {
                <div class="mt-2">
                    <img src="@AnnonceBilledeServicebilledeService.ConvertToUrl(newAnnonce.imageKey)" 
                         alt="Preview" width="120" />
                </div>
            }
        </div>

        @* --- KNAPPER --- *@
        <div class="col-12 mb-3">
            <button type="submit" class="btn btn-primary">Gem</button>
            <button type="button" class="btn btn-secondary ms-2" @onclick="ResetForm">
                Nulstil
            </button>
        </div>
    </EditForm>
</ModalDialog>

@code {
    private List<Annonce>? annoncer;         // Liste af annoncer hentet fra API
    private Annonce newAnnonce = new();      // Model til formularen i modal
    private ModalDialog? addModalDialog;     // Reference til modal-komponenten

    private string uploadStatus = "";        // Tekst der viser status på billedupload

    protected override async Task OnInitializedAsync()
    {
        // Hent alle annoncer når siden loader
        annoncer = await AnnonceService.GetAll() ?? new List<Annonce>();
    }

    private void OpenModal()
    {
        // Nulstil formular når modal åbnes
        newAnnonce = new Annonce();
        uploadStatus = "";
        addModalDialog?.Open();
    }

    @* --- BILLEDEUPLOAD LOGIK --- *@
    private async Task OnImageSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;

        // Åbn filen som stream (max 10MB)
        using var stream = file.OpenReadStream(maxAllowedSize: 10_000_000);

        // Upload filen til API'en via billedservice
        var (success, info) = await AnnonceBilledeServicebilledeService.SendFile(file.Name, stream);

        if (success)
        {
            newAnnonce.imageKey = info;           // Gem returned nøgle i annoncen
            uploadStatus = "Billedet er uploadet.";
        }
        else
        {
            uploadStatus = $"Fejl ved upload: {info}";
        }
    }

    private async Task HandleSubmit()
    {
        // GEMMER ANNONCEN (inkl. imageKey hvis sat)
        await AnnonceService.Add(newAnnonce);

        // Hent opdateret liste
        annoncer = await AnnonceService.GetAll() ?? new List<Annonce>();

        // Luk modal
        addModalDialog?.Close();

        // Nulstil formular
        newAnnonce = new Annonce();
        uploadStatus = "";

        StateHasChanged();
    }

    private async Task Delete(int id)
    {
        // Finder annoncen for at slette billedet også
        var annonce = annoncer?.FirstOrDefault(a => a.annonceid == id);

        if (annonce is not null && !string.IsNullOrEmpty(annonce.imageKey))
        {
            // Slet billedfilen fra serveren
            await AnnonceBilledeServicebilledeService.DeleteFile(annonce.imageKey);
        }

        // Slet selve annoncen i databasen
        await AnnonceService.DeleteById(id);

        // Hent opdateret liste
        annoncer = await AnnonceService.GetAll() ?? new List<Annonce>();

        StateHasChanged();
    }

    private void ResetForm()
    {
        // Nulstiller formular og billede status
        newAnnonce = new Annonce();
        uploadStatus = "";
    }
}
