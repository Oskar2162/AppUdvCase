@page "/Market"
@using BytteApp.Components
@using BytteApp.Service
@using Core
@inject AnnonceService annonceService

<h3>Tilføj annonce</h3>

@if (annoncer is null)
{
    <p>Loading annoncer...</p>
}
else if (annoncer.Count == 0)
{
    <p>Ingen annoncer lige nu</p>
}
else
{
    <h2 class="mt-4">Annoncer</h2>
    <table class="table table-striped">
        <thead>
        <tr>
            <th>Annonce Id</th>
            <th>Titel</th>
            <th>Pris</th>
            <th>Lokalitet Id</th>
            <th>Status</th>
            <th>Beskrivelse</th>
            <th>Handling</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var a in annoncer)
        {
            <tr>
                <td>@a.annonceid</td>
                <td>@a.title</td>
                <td>@a.price</td>
                <td>@a.lid</td>
                <td>@a.Status</td>
                <td>@a.description</td>
                <td>
                    <button class="btn btn-sm btn-danger" @onclick="() => Delete(a.annonceid)">Slet</button>
                </td>
            </tr>
        }
        </tbody>
    </table>
}

<button class="btn btn-info" @onclick="OpenModal">Tilføj annonce</button>

<ModalDialog @ref="addModalDialog" Title="Tilføj annonce...">
    <EditForm Model="@newAnnonce" OnValidSubmit="@HandleSubmit" class="row p-3">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="col-md-6 mb-3">
            <label for="AnnonceId">Annonce Id</label>
            <InputNumber id="AnnonceId" @bind-Value="newAnnonce.annonceid" class="form-control" disabled />
        </div>

        <div class="col-md-6 mb-3">
            <label for="Title">Titel</label>
            <InputText id="Title" @bind-Value="newAnnonce.title" class="form-control" />
        </div>

        <div class="col-md-6 mb-3">
            <label for="Price">Pris</label>
            <InputNumber id="Price" @bind-Value="newAnnonce.price" class="form-control" />
        </div>

        <div class="col-md-6 mb-3">
            <label for="Lid">Lokalitet Id</label>
            <InputNumber id="Lid" @bind-Value="newAnnonce.lid" class="form-control" />
        </div>

        <div class="col-md-6 mb-3">
            <label for="Status">Status</label>
            <InputText id="Status" @bind-Value="newAnnonce.Status" class="form-control" />
        </div>

        <div class="col-md-12 mb-3">
            <label for="Description">Beskrivelse</label>
            <InputTextArea id="Description" @bind-Value="newAnnonce.description" class="form-control" />
        </div>

        <div class="col-12 mb-3">
            <button type="submit" class="btn btn-primary">Gem</button>
            <button type="button" class="btn btn-secondary ms-2" @onclick="ResetForm">Nulstil</button>
        </div>
    </EditForm>
</ModalDialog>

@code {
    private List<Annonce>? annoncer;
    private Annonce newAnnonce = new();
    private ModalDialog? addModalDialog;

    
    private static readonly Random _rand = new();

    protected override async Task OnInitializedAsync()
    {
        annoncer = await annonceService.GetAll() ?? new List<Annonce>();
    }

    private void OpenModal()
    {
        newAnnonce = CreateNewAnnonce(); // nyt objekt med tilfældigt id
        addModalDialog?.Open();
    }

    private async Task HandleSubmit()
    {
        await annonceService.Add(newAnnonce);
        annoncer = await annonceService.GetAll() ?? new List<Annonce>();
        addModalDialog?.Close();
        newAnnonce = CreateNewAnnonce(); // klar til næste
        StateHasChanged();
    }

    private async Task Delete(int id)
    {
        await annonceService.DeleteById(id);
        annoncer = await annonceService.GetAll() ?? new List<Annonce>();
        StateHasChanged();
    }

    private void ResetForm()
    {
        newAnnonce = CreateNewAnnonce();
    }

    private Annonce CreateNewAnnonce()
    {
        return new Annonce
        {
            // 6-cifret id, simpelt og hurtigt
            annonceid = _rand.Next(100000, 1000000)
        };
    }
}