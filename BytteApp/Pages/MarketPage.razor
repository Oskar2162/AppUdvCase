@page "/Market"
@using BytteApp.Components
@using BytteApp.Service
@using Core
@inject AnnonceService annonceService
@inject UserService userService
@inject BytteApp.Service.LoginState loginState

<h3>Tilføj annonce</h3>

@if (annoncer is null)
{
    <p>Loading annoncer...</p>
}
else if (annoncer.Count == 0)
{
    <p>Ingen annoncer lige nu</p>
}
else
{
    <h2 class="mt-4">Annoncer</h2>
    <table class="table table-striped">
        <thead>
        <tr>
            <th>Annonce Id</th>
            <th>Titel</th>
            <th>Pris</th>
            <th>Lokalitet Id</th>
            <th>Status</th>
            <th>Beskrivelse</th>
            <th>Handling</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var a in annoncer)
        {
            <tr>
                <td>@a.annonceid</td>
                <td>@a.title</td>
                <td>@a.price</td>
                <td>@a.lid</td>
                <td>@a.Status</td>
                <td>@a.description</td>
                <td>

                    @* Hvis JEG er sælgeren *@
                    @if (a.userid == loginState.LoggedInUser)
                    {
                        <button class="btn btn-sm btn-danger" @onclick="() => Delete(a.annonceid)">Slet</button>

                        @if (!string.IsNullOrEmpty(a.BuyerUserId))
                        {
                            <!-- Der er en købsanmodning -->
                            <button class="btn btn-primary btn-sm ms-2" @onclick="() => Approve(a.annonceid)">Godkend</button>
                            <button class="btn btn-warning btn-sm ms-2" @onclick="() => Reject(a.annonceid)">Afvis</button>
                        }
                        else
                        {
                            <small class="text-muted ms-2">Ingen anmodning</small>
                        }
                    }
                    else
                    {
                        @* Hvis JEG ikke er sælgeren *@
                        <button class="btn btn-sm btn-success" @onclick="() => RequestPurchase(a.annonceid)">Køb</button>
                    }

                </td>
            </tr>
        }
        </tbody>
    </table>
}

<button class="btn btn-info" @onclick="OpenModal">Tilføj annonce</button>

<ModalDialog @ref="addModalDialog" Title="Ny annonce">
    <EditForm Model="newAnnonce" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />
        
        <div class="col-md-6 mb-3">
            <label for="AnnonceId">Annonce Id</label>
            <InputNumber id="AnnonceId" @bind-Value="newAnnonce.annonceid" class="form-control" disabled />
        </div>

        <div class="col-md-6 mb-3">
            <label for="Title">Titel</label>
            <InputText id="Title" @bind-Value="newAnnonce.title" class="form-control" />
        </div>

        <div class="col-md-6 mb-3">
            <label for="Price">Pris</label>
            <InputNumber id="Price" @bind-Value="newAnnonce.price" class="form-control" />
        </div>

        <div class="col-md-6 mb-3">
            <label for="Lid">Lokalitet Id</label>
            <InputNumber id="Lid" @bind-Value="newAnnonce.lid" class="form-control" />
        </div>

        <div class="col-md-6 mb-3">
            <label for="Status">Status</label>
            <InputText id="Status" @bind-Value="newAnnonce.Status" class="form-control" />
        </div>

        <div class="col-md-12 mb-3">
            <label for="Description">Beskrivelse</label>
            <InputTextArea id="Description" @bind-Value="newAnnonce.description" class="form-control" />
        </div>

        @* Vis kun hvis sat *@
        @if (!string.IsNullOrWhiteSpace(newAnnonce.userid))
        {
            <div class="col-md-12 mb-2">
                <small>Bruger: @newAnnonce.userid</small>
            </div>
        }

        <div class="col-12 mb-3">
            <button type="submit" class="btn btn-primary" disabled="@(!loginState.IsLoggedIn())">Gem</button>
            <button type="button" class="btn btn-secondary ms-2" @onclick="ResetForm">Nulstil</button>
        </div>

        @if(!loginState.IsLoggedIn())
        {
            <div class="alert alert-warning">
                Du skal være logget ind for at oprette en annonce.
            </div>
        }
    </EditForm>
</ModalDialog>

@code {
    private List<Annonce>? annoncer;
    private Annonce newAnnonce = new();
    private ModalDialog? addModalDialog;

    private static readonly Random _rand = new();

    protected override async Task OnInitializedAsync()
    {
        annoncer = await annonceService.GetAll() ?? new List<Annonce>();
        PrepareNewAnnonce();
    }

    private void OpenModal()
    {
        PrepareNewAnnonce();
        addModalDialog?.Open();
    }

    private async Task HandleSubmit()
    {
        if(!loginState.IsLoggedIn())
            return; // sikkerhed

        // Sørg for at userid er opdateret lige før send
        newAnnonce.userid = loginState.LoggedInUser!;

        await annonceService.Add(newAnnonce);
        annoncer = await annonceService.GetAll() ?? new List<Annonce>();
        addModalDialog?.Close();
        PrepareNewAnnonce();
        StateHasChanged();
    }

    private async Task Delete(int id)
    {
        await annonceService.DeleteById(id);
        annoncer = await annonceService.GetAll() ?? new List<Annonce>();
        StateHasChanged();
    }

    private void ResetForm()
    {
        PrepareNewAnnonce();
    }

    private void PrepareNewAnnonce()
    {
        newAnnonce = new Annonce
        {
            annonceid = _rand.Next(1, 100000),
            userid = loginState.LoggedInUser ?? string.Empty, // tom hvis ikke logget ind
            Status = "Active"
        };
    }

    private async Task RequestPurchase(int annonceId)
    {

        if (!loginState.IsLoggedIn())
        {
            Console.WriteLine("Ingen bruger logget ind");
            return;
        }

        await annonceService.SendPurchaseRequest(annonceId, loginState.LoggedInUser!);

        annoncer = await annonceService.GetAll();
        StateHasChanged();
    }
    private async Task Approve(int annonceId)
    {
        await annonceService.Approve(annonceId);
        annoncer = await annonceService.GetAll();
        StateHasChanged();
    }

    private async Task Reject(int annonceId)
    {
        await annonceService.Reject(annonceId);
        annoncer = await annonceService.GetAll();
        StateHasChanged();
    }
}